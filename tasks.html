<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Tasks - Taskly</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        nav {
            background-color: #2c5282;
            padding: 1rem;
            display: flex;
            gap: 2rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }

        nav a:hover {
            text-decoration: underline;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tasks header and filters */
        .tasks-header {
            margin-bottom: 2rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .filter-select,
        .location-input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }

        /* Tasks grid */
        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        /* Task card styles */
        .task-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .task-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #333;
        }

        .task-budget {
            font-weight: bold;
            color: #2c5282;
            background-color: #ebf8ff;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }

        .task-type,
        .task-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .task-description {
            color: #444;
            margin: 1rem 0;
            line-height: 1.5;
        }

        .task-flairs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .flair-tag {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: #f0f0f0;
        }

        .flair-tag.urgent {
            background-color: #fff5f5;
            color: #c53030;
        }

        .flair-tag.heavy-lifting {
            background-color: #f0f4ff;
            color: #434190;
        }

        .flair-tag.vehicle-needed {
            background-color: #f0fff4;
            color: #276749;
        }

        .flair-tag.tools-required {
            background-color: #fff5f7;
            color: #702459;
        }

        .flair-tag.expertise-required {
            background-color: #fffaf0;
            color: #744210;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .task-date {
            color: #666;
            font-size: 0.9rem;
        }

        .apply-button {
            background-color: #2c5282;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .apply-button:hover {
            background-color: #2a4365;
        }

        .error {
            text-align: center;
            color: #c53030;
            padding: 2rem;
        }

        footer {
            text-align: center;
            padding: 2rem;
            background-color: #f5f5f5;
            margin-top: 2rem;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }

            .filter-select,
            .location-input {
                width: 100%;
            }

            main {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="create-task.html">Create Task</a>
        <a href="become-worker.html">Become a Worker</a>
        <a href="tasks.html">List of Tasks</a>
        <a href="#messages">Messages</a>
    </nav>

    <main role="main">
        <section class="tasks-header">
            <h1>Available Tasks</h1>
            <div class="filters">
                <select id="taskType" class="filter-select">
                    <option value="">All Task Types</option>
                    <option value="Home Maintenance">Home Maintenance</option>
                    <option value="Gardening">Gardening</option>
                    <option value="Delivery">Delivery</option>
                    <option value="Cleaning">Cleaning</option>
                    <option value="Furniture Assembly">Furniture Assembly</option>
                    <option value="Moving Help">Moving Help</option>
                    <option value="Tech Support">Tech Support</option>
                    <option value="Other">Other</option>
                </select>

                <select id="sortBy" class="filter-select">
                    <option value="date">Newest First</option>
                    <option value="budget-high">Budget: High to Low</option>
                    <option value="budget-low">Budget: Low to High</option>
                    <option value="urgent">Urgent First</option>
                </select>

                <input type="text" id="locationFilter" placeholder="Filter by location" class="location-input">
            </div>
        </section>

        <section id="tasksList" class="tasks-grid">
            <!-- Tasks will be populated here -->
            <div class="loading">Loading tasks...</div>
        </section>
    </main>

    <footer>
        Â© 2024 Taskly. All rights reserved.
    </footer>

    <script>
        let currentTasks = [];

        // Fetch tasks from the server
        async function fetchTasks() {
            try {
                const response = await fetch('/api/tasks');
                if (!response.ok) {
                    throw new Error('Failed to fetch tasks');
                }
                currentTasks = await response.json();
                displayTasks(currentTasks);
            } catch (error) {
                console.error('Error fetching tasks:', error);
                document.getElementById('tasksList').innerHTML = 
                    '<p class="error">Error loading tasks. Please try again later.</p>';
            }
        }

        // Display tasks in the grid
        function displayTasks(tasks) {
            const tasksContainer = document.getElementById('tasksList');
            tasksContainer.innerHTML = '';

            if (tasks.length === 0) {
                tasksContainer.innerHTML = '<p class="error">No tasks found matching your criteria.</p>';
                return;
            }

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                
                const flairHtml = task.flairs ? task.flairs.map(flair => 
                    `<span class="flair-tag ${flair.toLowerCase().replace(/\s+/g, '-')}">${flair}</span>`
                ).join('') : '';

                taskCard.innerHTML = `
                    <div class="task-header">
                        <h2>${task.title}</h2>
                        <span class="task-budget">$${task.budget.toFixed(2)}</span>
                    </div>
                    <div class="task-type">${task.type}</div>
                    <div class="task-location">${task.location}</div>
                    <p class="task-description">${task.description}</p>
                    <div class="task-flairs">
                        ${flairHtml}
                    </div>
                    <div class="task-footer">
                        <span class="task-date">Posted: ${formatDate(task.datePosted)}</span>
                        <button onclick="applyForTask(${task.id})" class="apply-button">Apply</button>
                    </div>
                `;
                
                tasksContainer.appendChild(taskCard);
            });
        }

        // Format date to a readable string
        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // Filter tasks based on user selection
        function filterTasks() {
            const taskType = document.getElementById('taskType').value;
            const sortBy = document.getElementById('sortBy').value;
            const location = document.getElementById('locationFilter').value.toLowerCase();

            let filteredTasks = [...currentTasks];

            // Apply filters
            if (taskType) {
                filteredTasks = filteredTasks.filter(task => task.type === taskType);
            }

            if (location) {
                filteredTasks = filteredTasks.filter(task => 
                    task.location.toLowerCase().includes(location)
                );
            }

            // Apply sorting
            switch (sortBy) {
                case 'budget-high':
                    filteredTasks.sort((a, b) => b.budget - a.budget);
                    break;
                case 'budget-low':
                    filteredTasks.sort((a, b) => a.budget - b.budget);
                    break;
                case 'urgent':
                    filteredTasks.sort((a, b) => {
                        const aUrgent = a.flairs.includes('Urgent');
                        const bUrgent = b.flairs.includes('Urgent');
                        return bUrgent - aUrgent;
                    });
                    break;
                default: // date
                    filteredTasks.sort((a, b) => 
                        new Date(b.datePosted) - new Date(a.datePosted)
                    );
            }

            displayTasks(filteredTasks);
        }

        // Apply for a task
        async function applyForTask(taskId) {
            try {
                const response = await fetch('/api/tasks/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ taskId })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Application submitted successfully!');
                } else {
                    throw new Error(data.message || 'Failed to apply for task');
                }
            } catch (error) {
                console.error('Error applying for task:', error);
                alert('Error applying for task: ' + error.message);
            }
        }

        // Add event listeners for filters
        document.getElementById('taskType').addEventListener('change', filterTasks);
        document.getElementById('sortBy').addEventListener('change', filterTasks);
        document.getElementById('locationFilter').addEventListener('input', filterTasks);

        // Load tasks when page loads
        document.addEventListener('DOMContentLoaded', fetchTasks);
    </script>
</body>
</html>